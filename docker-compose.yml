# =============================================================
# InfraPilot - Quick Start (All-in-One Image)
# =============================================================
#
# Usage:
#   docker compose up -d
#
# Dashboard: http://localhost
# Default:   admin@infrapilot.local / admin123
#
# =============================================================

services:
  infrapilot:
    image: devsimplex/infrapilot:${VERSION:-latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: infrapilot
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    environment:
      # Required
      JWT_SECRET: "${JWT_SECRET:?JWT_SECRET is required - generate with: openssl rand -base64 32}"

      # Optional - Database (uses embedded PostgreSQL if not set)
      DATABASE_URL: ${DATABASE_URL:-}
      POSTGRES_USER: ${POSTGRES_USER:-infrapilot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-infrapilot}
      POSTGRES_DB: ${POSTGRES_DB:-infrapilot}

      # Optional - Redis (uses embedded Redis if not set)
      REDIS_URL: ${REDIS_URL:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-infrapilot}

      # Optional - SSL/Let's Encrypt
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-}
      LETSENCRYPT_STAGING: ${LETSENCRYPT_STAGING:-true}

      # Optional - CORS origins
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost,http://localhost:80}
    volumes:
      # Persistent data
      - infrapilot_data:/data

      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

volumes:
  infrapilot_data:
