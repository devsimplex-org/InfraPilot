# =============================================================
# InfraPilot Community Edition - Single Node Deployment
# =============================================================
#
# Self-hosted, all-in-one deployment with built-in agent
#
# Quick Start:
#   docker compose up -d
#
# Dashboard: http://localhost
# First-time setup creates admin account
#
# Features included:
#   - Nginx proxy management with SSL automation
#   - Docker container management
#   - Real-time logs and terminal
#   - Alerts and notifications
#   - Health monitoring
#
# =============================================================

services:
  infrapilot:
    image: devsimplex/infrapilot:${VERSION:-latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: infrapilot
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    environment:
      # Required - generate with: openssl rand -base64 32
      JWT_SECRET: "${JWT_SECRET:?JWT_SECRET is required}"

      # Database (uses embedded PostgreSQL if not set)
      DATABASE_URL: ${DATABASE_URL:-}
      POSTGRES_USER: ${POSTGRES_USER:-infrapilot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-infrapilot}
      POSTGRES_DB: ${POSTGRES_DB:-infrapilot}

      # Redis (uses embedded Redis if not set)
      REDIS_URL: ${REDIS_URL:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-infrapilot}

      # SSL/Let's Encrypt (optional)
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL:-}
      LETSENCRYPT_STAGING: ${LETSENCRYPT_STAGING:-true}

      # Basic Auth (optional - set both to enable)
      BASIC_AUTH_USER: ${BASIC_AUTH_USER:-}
      BASIC_AUTH_PASSWORD: ${BASIC_AUTH_PASSWORD:-}

      # CORS origins
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost,https://localhost}
    volumes:
      # Persistent data on host (database, certs, config)
      - ${DATA_DIR:-./data}:/data

      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
